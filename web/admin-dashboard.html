<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Firebase Products</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logout-button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }
        .logout-button:hover {
            background: rgba(255,255,255,0.3);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: 300px;
            margin-right: 10px;
        }
        .controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
        }
        .controls button:hover {
            background: #5568d3;
        }
        .controls button.danger {
            background: #dc3545;
        }
        .controls button.danger:hover {
            background: #c82333;
        }
        table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        thead {
            background: #667eea;
            color: white;
        }
        th, td {
            padding: 15px;
            text-align: left;
        }
        tbody tr {
            border-bottom: 1px solid #e0e0e0;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .btn-edit, .btn-delete {
            padding: 5px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-edit {
            background: #28a745;
            color: white;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close {
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üìä Admin Dashboard</h1>
            <p>Manage Products in Firebase</p>
        </div>
        <button class="logout-button" onclick="handleLogout()">Logout</button>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <h3>Total Products</h3>
            <div class="value" id="totalProducts">0</div>
        </div>
        <div class="stat-card">
            <h3>Total Categories</h3>
            <div class="value" id="totalCategories">0</div>
        </div>
        <div class="stat-card">
            <h3>Admin Accounts</h3>
            <div class="value" id="totalAdmins">0</div>
        </div>
    </div>
    
    <div class="controls">
        <input type="text" id="searchInput" placeholder="Search products...">
        <button onclick="loadProducts()">üîÑ Refresh</button>
        <button onclick="openAddModal()">‚ûï Add Product</button>
        <button onclick="openAdminModal()">üë§ Create Admin</button>
    </div>
    
    <div id="message"></div>
    
    <table>
        <thead>
            <tr>
                <th>Image</th>
                <th>ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Category</th>
                <th>Gender</th>
                <th>Stock</th>
                <th>On Sale</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="productsTable">
            <tr>
                <td colspan="9" style="text-align: center; padding: 40px;">
                    Loading products...
                </td>
            </tr>
        </tbody>
    </table>
    
    <!-- Load More Button -->
    <div style="text-align: center; margin: 20px 0;">
        <div id="productCount" style="color: #666; margin-bottom: 10px; font-size: 14px;">
            Showing 0 products
        </div>
        <button id="loadMoreButton" onclick="loadMoreProducts()" 
                style="display: none; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
            üìÑ Load More (20)
        </button>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Product</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" id="editPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="editCategory" required>
                        <option value="Hoodies">Hoodies</option>
                        <option value="Jackets">Jackets</option>
                        <option value="T-Shirts">T-Shirts</option>
                        <option value="Pants">Pants</option>
                        <option value="Shoes">Shoes</option>
                        <option value="Accessories">Accessories</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="editGender">
                        <option value="">Select Gender</option>
                        <option value="Men">Men</option>
                        <option value="Women">Women</option>
                        <option value="Kids">Kids</option>
                        <option value="Unisex">Unisex</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Upload New Images (from device)</label>
                    <input type="file" id="editImageInput" multiple accept="image/*" style="padding: 10px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9ff; cursor: pointer; width: 100%;">
                    <div id="editImagePreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                    <small style="color: #666; display: block; margin-top: 5px;">Current images will be kept. New images will be added.</small>
                </div>
                <div class="form-group">
                    <label>On Sale</label>
                    <input type="checkbox" id="editOnSale">
                </div>
                <div class="form-group">
                    <label>Free Shipping</label>
                    <input type="checkbox" id="editFreeShipping">
                </div>
                <div class="form-group">
                    <label>Stock Quantity</label>
                    <input type="number" id="editStock" min="0" value="0" required>
                    <small style="color: #666; display: block; margin-top: 5px;">Enter the number of items in stock</small>
                </div>
                <button type="submit" style="width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Update Product</button>
            </form>
        </div>
    </div>
    
    <!-- Admin Management Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Admin Account</h2>
                <span class="close" onclick="closeAdminModal()">&times;</span>
            </div>
            <form id="adminForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="adminEmail" required placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="adminPassword" required placeholder="Minimum 6 characters" minlength="6">
                </div>
                <div id="adminMessage" class="message"></div>
                <button type="submit" style="width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Create Admin Account</button>
            </form>
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px; color: #667eea;">Current Admin Accounts</h3>
                <div id="adminList" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #666; text-align: center; padding: 20px;">Loading admins...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration is loaded from config.js
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Test Firestore connection
        async function testConnection() {
            try {
                console.log('Testing Firestore connection...');
                console.log('Firestore instance:', db);
                console.log('Firestore settings:', db.settings);
                
                // Try to read from a collection to test connection
                const testSnapshot = await db.collection('products').limit(1).get();
                console.log('‚úÖ Firestore connection successful');
                console.log('Test query returned:', testSnapshot.size, 'documents');
                return true;
            } catch (error) {
                console.error('‚ùå Firestore connection failed:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                showMessage('Database connection error: ' + error.message + ' (Code: ' + (error.code || 'unknown') + ')', 'error');
                return false;
            }
        }
        
        // Check authentication and admin status
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                // Not logged in, redirect to login
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Test connection first
            const connected = await testConnection();
            if (!connected) {
                return;
            }
            
            // Check if user is admin
            try {
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                if (!adminDoc.exists) {
                    // User is not admin, sign out and redirect
                    await auth.signOut();
                    window.location.href = 'admin-login.html';
                } else {
                    // User is admin, load products immediately
                    loadProducts();
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
                showMessage('Error checking admin status: ' + error.message, 'error');
                try {
                    await auth.signOut();
                    window.location.href = 'admin-login.html';
                } catch (signOutError) {
                    console.error('Error signing out:', signOutError);
                }
            }
        });
        
        // Logout function
        function handleLogout() {
            auth.signOut().then(() => {
                window.location.href = 'admin-login.html';
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        let products = [];
        let displayedProducts = []; // Products currently displayed
        let lastDoc = null; // Last document for pagination
        let hasMoreProducts = true; // Whether there are more products to load
        let editSelectedFiles = [];

        // Image preview for edit modal
        document.getElementById('editImageInput')?.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            editSelectedFiles = files;
            const preview = document.getElementById('editImagePreview');
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.style.position = 'relative';
                    div.innerHTML = `
                        <img src="${e.target.result}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeEditImage(${index})" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });

        function removeEditImage(index) {
            editSelectedFiles.splice(index, 1);
            const input = document.getElementById('editImageInput');
            const dt = new DataTransfer();
            editSelectedFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;
            input.dispatchEvent(new Event('change'));
        }

        async function uploadImages(files) {
            const uploadedUrls = [];
            const uploadPromises = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileName = `products/${Date.now()}_${Math.random().toString(36).substring(7)}_${file.name}`;
                const storageRef = storage.ref().child(fileName);
                
                const uploadPromise = storageRef.put(file).then(snapshot => {
                    return snapshot.ref.getDownloadURL();
                }).then(url => {
                    uploadedUrls.push(url);
                    return url;
                }).catch(error => {
                    console.error('Error uploading image:', error);
                    throw error;
                });
                
                uploadPromises.push(uploadPromise);
            }
            
            await Promise.all(uploadPromises);
            return uploadedUrls;
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        async function loadProducts() {
            // Check if db is initialized
            if (!db) {
                console.error('Firestore not initialized');
                const tbody = document.getElementById('productsTable');
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">Error: Database not initialized. Please refresh the page.</td></tr>';
                return;
            }
            
            const tbody = document.getElementById('productsTable');
            const refreshButton = document.querySelector('button[onclick="loadProducts()"]');
            const loadMoreButton = document.getElementById('loadMoreButton');
            
            try {
                // Show loading state
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;"><div style="display: inline-block; padding: 10px 20px; background: #f0f0f0; border-radius: 8px;">Loading products...</div></td></tr>';
                if (refreshButton) {
                    refreshButton.disabled = true;
                    refreshButton.textContent = '‚è≥ Loading...';
                }
                if (loadMoreButton) {
                    loadMoreButton.style.display = 'none';
                }
                
                // Reset pagination
                products = [];
                displayedProducts = [];
                lastDoc = null;
                hasMoreProducts = true;
                
                console.log('Loading products from Firestore...');
                console.log('Firestore db instance:', db);
                console.log('Collection reference:', db.collection('products'));
                
                // Load first 20 products
                const snapshot = await db.collection('products').limit(20).get();
                console.log('‚úÖ Query successful. Products loaded:', snapshot.size);
                console.log('Snapshot empty?', snapshot.empty);
                console.log('Snapshot docs:', snapshot.docs.length);
                
                hasMoreProducts = snapshot.size === 20;
                
                if (snapshot.empty) {
                    console.log('‚ö†Ô∏è No products found in database');
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">No products found. Click "Add Product" to create one.</td></tr>';
                    updateStats();
                    if (refreshButton) {
                        refreshButton.disabled = false;
                        refreshButton.textContent = 'üîÑ Refresh';
                    }
                    return;
                }
                
                snapshot.forEach((doc, index) => {
                    try {
                        const data = doc.data();
                        console.log(`Processing product ${index + 1}:`, doc.id, data.name || 'No name');
                        const product = {
                            id: doc.id,
                            ...data
                        };
                        products.push(product);
                        displayedProducts.push(product);
                        lastDoc = doc; // Keep track of last document for pagination
                    } catch (parseError) {
                        console.error('Error parsing product:', doc.id, parseError);
                    }
                });
                
                console.log('‚úÖ Processed', displayedProducts.length, 'products successfully');
                
                // Sort in memory (faster for smaller datasets)
                displayedProducts.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis?.() || a.createdAt || 0;
                    const bTime = b.createdAt?.toMillis?.() || b.createdAt || 0;
                    return bTime - aTime; // Descending order
                });
                
                // Update UI immediately with first batch
                updateStats();
                renderProducts();
                
                // Show load more button if there are more products
                if (hasMoreProducts && loadMoreButton) {
                    loadMoreButton.style.display = 'block';
                }
                
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.textContent = 'üîÑ Refresh';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                let errorMsg = 'Error loading products: ' + error.message;
                
                // More specific error messages
                if (error.code === 'permission-denied') {
                    errorMsg = 'Permission denied. Please check Firestore security rules.';
                } else if (error.code === 'unavailable') {
                    errorMsg = 'Database unavailable. Please check your internet connection.';
                } else if (error.message.includes('network')) {
                    errorMsg = 'Network error. Please check your internet connection.';
                }
                
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">' + errorMsg + '</td></tr>';
                showMessage(errorMsg, 'error');
                
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.textContent = 'üîÑ Refresh';
                }
            }
        }
        
        // Load next 20 products (pagination)
        async function loadMoreProducts() {
            if (!hasMoreProducts || !lastDoc) {
                return;
            }
            
            const loadMoreButton = document.getElementById('loadMoreButton');
            if (loadMoreButton) {
                loadMoreButton.disabled = true;
                loadMoreButton.textContent = '‚è≥ Loading...';
            }
            
            try {
                // Load next 20 products starting from lastDoc
                const snapshot = await db.collection('products')
                    .startAfter(lastDoc)
                    .limit(20)
                    .get();
                
                if (snapshot.empty) {
                    hasMoreProducts = false;
                    if (loadMoreButton) {
                        loadMoreButton.style.display = 'none';
                    }
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const product = {
                        id: doc.id,
                        ...data
                    };
                    products.push(product);
                    displayedProducts.push(product);
                    lastDoc = doc;
                });
                
                // Check if there are more products
                hasMoreProducts = snapshot.size === 20;
                
                // Sort displayed products
                displayedProducts.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis?.() || a.createdAt || 0;
                    const bTime = b.createdAt?.toMillis?.() || b.createdAt || 0;
                    return bTime - aTime;
                });
                
                // Update UI
                updateStats();
                renderProducts();
                
                // Hide button if no more products
                if (!hasMoreProducts && loadMoreButton) {
                    loadMoreButton.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading more products:', error);
                showMessage('Error loading more products: ' + error.message, 'error');
            } finally {
                if (loadMoreButton) {
                    loadMoreButton.disabled = false;
                    loadMoreButton.textContent = 'üìÑ Load More (20)';
                }
            }
        }

        async function updateStats() {
            // Show displayed products count, not total (since we're paginating)
            document.getElementById('totalProducts').textContent = displayedProducts.length + (hasMoreProducts ? '+' : '');
            const categories = new Set(displayedProducts.map(p => p.category).filter(c => c));
            document.getElementById('totalCategories').textContent = categories.size;
            
            // Update product count display
            const productCount = document.getElementById('productCount');
            if (productCount) {
                if (displayedProducts.length === 0) {
                    productCount.textContent = 'No products loaded';
                } else if (hasMoreProducts) {
                    productCount.textContent = `Showing ${displayedProducts.length} products (more available)`;
                } else {
                    productCount.textContent = `Showing all ${displayedProducts.length} products`;
                }
            }
            
            // Update admin count (cache this to avoid loading every time)
            if (!window.adminCount || Date.now() - window.adminCountTime > 30000) { // Cache for 30 seconds
                try {
                    const adminSnapshot = await db.collection('admins').get();
                    window.adminCount = adminSnapshot.size;
                    window.adminCountTime = Date.now();
                    document.getElementById('totalAdmins').textContent = window.adminCount;
                } catch (error) {
                    console.error('Error loading admin count:', error);
                    // Use cached value if available
                    if (window.adminCount) {
                        document.getElementById('totalAdmins').textContent = window.adminCount;
                    }
                }
            } else {
                document.getElementById('totalAdmins').textContent = window.adminCount;
            }
        }

        function renderProducts() {
            const tbody = document.getElementById('productsTable');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Filter displayed products (not all products, just what's loaded)
            const filteredProducts = displayedProducts.filter(p => 
                p.name?.toLowerCase().includes(searchTerm) ||
                p.category?.toLowerCase().includes(searchTerm) ||
                p.id?.toLowerCase().includes(searchTerm)
            );
            
            // Show message if no products
            if (filteredProducts.length === 0) {
                if (displayedProducts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">No products found. Click "Add Product" to create one.</td></tr>';
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">No products match your search.</td></tr>';
                }
                // Hide load more button when searching
                const loadMoreButton = document.getElementById('loadMoreButton');
                if (loadMoreButton) {
                    loadMoreButton.style.display = 'none';
                }
                return;
            }
            
            // Show load more button if not searching and there are more products
            const loadMoreButton = document.getElementById('loadMoreButton');
            if (searchTerm === '' && hasMoreProducts) {
                if (loadMoreButton) {
                    loadMoreButton.style.display = 'block';
                }
            } else {
                if (loadMoreButton) {
                    loadMoreButton.style.display = 'none';
                }
            }
            
            tbody.innerHTML = filteredProducts.map(product => {
                const firstImage = product.images && product.images.length > 0 ? product.images[0] : '';
                const stock = product.stock !== undefined ? product.stock : 0;
                const stockDisplay = stock > 0 ? stock : '<span style="color: #dc3545; font-weight: bold;">No Stock</span>';
                return `
                <tr>
                    <td>
                        ${firstImage ? `<img src="${firstImage}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" onerror="this.style.display='none'">` : 'üì∑'}
                    </td>
                    <td>${product.id.substring(0, 8)}...</td>
                    <td>${product.name}</td>
                    <td>${product.priceString || '$' + product.price}</td>
                    <td>${product.category || '-'}</td>
                    <td>${product.gender || '-'}</td>
                    <td>${stockDisplay}</td>
                    <td>${product.onSale ? '‚úÖ' : '‚ùå'}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-edit" onclick="editProduct('${product.id}')">Edit</button>
                            <button class="btn-delete" onclick="deleteProduct('${product.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            try {
                await db.collection('products').doc(id).delete();
                showMessage('Product deleted successfully', 'success');
                // Remove from displayed products
                displayedProducts = displayedProducts.filter(p => p.id !== id);
                products = products.filter(p => p.id !== id);
                updateStats();
                renderProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                showMessage('Error deleting product: ' + error.message, 'error');
            }
        }


        function editProduct(id) {
            const product = displayedProducts.find(p => p.id == id) || products.find(p => p.id == id);
            if (!product) return;
            
            document.getElementById('editId').value = id;
            document.getElementById('editName').value = product.name;
            document.getElementById('editPrice').value = product.price;
            document.getElementById('editCategory').value = product.category || '';
            document.getElementById('editGender').value = product.gender || '';
            document.getElementById('editDescription').value = product.description || '';
            document.getElementById('editOnSale').checked = product.onSale || false;
            document.getElementById('editFreeShipping').checked = product.freeShipping || false;
            document.getElementById('editStock').value = product.stock !== undefined ? product.stock : 0;
            
            // Show current images
            const preview = document.getElementById('editImagePreview');
            preview.innerHTML = '';
            if (product.images && product.images.length > 0) {
                product.images.forEach((url, index) => {
                    const div = document.createElement('div');
                    div.style.position = 'relative';
                    div.innerHTML = `
                        <img src="${url}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                        <small style="display: block; text-align: center; margin-top: 5px; color: #666;">Current</small>
                    `;
                    preview.appendChild(div);
                });
            }
            
            editSelectedFiles = [];
            document.getElementById('editImageInput').value = '';
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        function openAdminModal() {
            document.getElementById('adminModal').style.display = 'block';
            // Only load admins if db is initialized
            if (db) {
                loadAdmins();
            } else {
                document.getElementById('adminList').innerHTML = '<p style="color: #dc3545; text-align: center; padding: 20px;">Error: Database not initialized. Please refresh the page.</p>';
            }
        }
        
        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminForm').reset();
            document.getElementById('adminMessage').textContent = '';
            document.getElementById('adminMessage').className = 'message';
        }
        
        async function loadAdmins() {
            try {
                // Check if db is initialized
                if (!db) {
                    console.error('Firestore not initialized');
                    return;
                }
                
                const adminList = document.getElementById('adminList');
                adminList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Loading admins...</p>';
                
                const snapshot = await db.collection('admins').get();
                
                if (snapshot.empty) {
                    adminList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No admin accounts found.</p>';
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                snapshot.forEach(doc => {
                    const adminData = doc.data();
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                            <div>
                                <strong>${adminData.email || 'N/A'}</strong>
                                <br>
                                <small style="color: #666;">UID: ${doc.id}</small>
                            </div>
                            <button onclick="removeAdmin('${doc.id}', '${adminData.email || ''}')" 
                                    style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                Remove
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                adminList.innerHTML = html;
            } catch (error) {
                console.error('Error loading admins:', error);
                document.getElementById('adminList').innerHTML = '<p style="color: #dc3545; text-align: center; padding: 20px;">Error loading admins: ' + error.message + '</p>';
            }
        }
        
        async function removeAdmin(uid, email) {
            if (!confirm(`Are you sure you want to remove admin account "${email}"?`)) {
                return;
            }
            
            try {
                await db.collection('admins').doc(uid).delete();
                showAdminMessage('Admin account removed successfully!', 'success');
                loadAdmins();
                updateStats();
            } catch (error) {
                console.error('Error removing admin:', error);
                showAdminMessage('Error removing admin: ' + error.message, 'error');
            }
        }
        
        function showAdminMessage(text, type) {
            const messageDiv = document.getElementById('adminMessage');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
        }
        
        // Admin form submission
        document.getElementById('adminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            submitButton.disabled = true;
            submitButton.textContent = 'Creating...';
            showAdminMessage('Creating admin account...', 'info');
            
            try {
                // Step 1: Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Step 2: Add user to admins collection
                await db.collection('admins').doc(user.uid).set({
                    email: email,
                    role: 'admin',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showAdminMessage('‚úÖ Admin account created successfully!', 'success');
                document.getElementById('adminForm').reset();
                loadAdmins();
                updateStats();
                
            } catch (error) {
                console.error('Error creating admin:', error);
                let errorMsg = 'Failed to create admin account.';
                
                if (error.code === 'auth/email-already-in-use') {
                    // User exists, try to add to admins
                    try {
                        showAdminMessage('User exists. Adding to admins...', 'info');
                        const user = await auth.signInWithEmailAndPassword(email, password);
                        await db.collection('admins').doc(user.uid).set({
                            email: email,
                            role: 'admin',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await auth.signOut();
                        showAdminMessage('‚úÖ User already exists. Added to admins!', 'success');
                        loadAdmins();
                        updateStats();
                        document.getElementById('adminForm').reset();
                        return;
                    } catch (addError) {
                        errorMsg = 'User exists but failed to add to admins. ' + addError.message;
                    }
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = 'Password is too weak. Please use at least 6 characters.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'Invalid email address.';
                } else {
                    errorMsg = error.message || 'Failed to create admin account.';
                }
                
                showAdminMessage(errorMsg, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Create Admin Account';
            }
        });
        
        // Note: loadAdmins() is called when admin modal is opened, not on page load

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Uploading images...';
                submitBtn.disabled = true;
                
                // Upload new images if any
                let newImageUrls = [];
                if (editSelectedFiles.length > 0) {
                    newImageUrls = await uploadImages(editSelectedFiles);
                }
                
                // Get current product to preserve existing images
                const product = products.find(p => p.id == document.getElementById('editId').value);
                const existingImages = product.images || [];
                const allImages = [...existingImages, ...newImageUrls];
                
                submitBtn.textContent = 'Updating product...';
                
                const id = document.getElementById('editId').value;
                const updateData = {
                    name: document.getElementById('editName').value,
                    price: parseFloat(document.getElementById('editPrice').value),
                    priceString: `$${parseFloat(document.getElementById('editPrice').value).toFixed(2)}`,
                    category: document.getElementById('editCategory').value,
                    gender: document.getElementById('editGender').value,
                    description: document.getElementById('editDescription').value,
                    images: allImages,
                    onSale: document.getElementById('editOnSale').checked,
                    freeShipping: document.getElementById('editFreeShipping').checked,
                    stock: parseInt(document.getElementById('editStock').value) || 0,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('products').doc(id).update(updateData);
                showMessage('Product updated successfully', 'success');
                closeModal();
                // Update the product in displayedProducts
                const productIndex = displayedProducts.findIndex(p => p.id === id);
                if (productIndex !== -1) {
                    displayedProducts[productIndex] = {
                        ...displayedProducts[productIndex],
                        ...updateData
                    };
                }
                updateStats();
                renderProducts();
            } catch (error) {
                console.error('Error updating product:', error);
                showMessage('Error updating product: ' + error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        function openAddModal() {
            window.open('add-product.html', '_blank');
        }

        document.getElementById('searchInput').addEventListener('input', () => {
            renderProducts();
            // Hide load more button when searching
            const loadMoreButton = document.getElementById('loadMoreButton');
            if (loadMoreButton) {
                loadMoreButton.style.display = 'none';
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const adminModal = document.getElementById('adminModal');
            if (event.target == editModal) {
                closeModal();
            }
            if (event.target == adminModal) {
                closeAdminModal();
            }
        }

        // Products will be loaded after auth check passes (see auth.onAuthStateChanged above)
    </script>
</body>
</html>

